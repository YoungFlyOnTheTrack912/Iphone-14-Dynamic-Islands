<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Web Proxy</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { width: 100%; height: 100vh; overflow: hidden; }
    #iframe { width: 100%; height: 100%; border: none; }
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 10000; }
    #loading.hidden { display: none; }
  </style>
</head>
<body>
  <div id="loading">
    <div style="text-align: center;">
      <h2>Loading...</h2>
    </div>
  </div>
  <iframe id="iframe"></iframe>

  <script>
    // Get the target URL from the URL parameter or hash
    const params = new URLSearchParams(window.location.search);
    let targetUrl = params.get('url');

    // If no URL in search params, try to use the pathname as domain
    if (!targetUrl && window.location.pathname !== '/' && window.location.pathname !== '/proxy-frame.html') {
      // Extract domain from pathname or use it as a domain
      const path = window.location.pathname.replace(/^\/proxy-frame\//, '');
      if (path) {
        targetUrl = /^https?:\/\//.test(path) ? path : 'https://' + path;
      }
    }

    const iframe = document.getElementById('iframe');
    const loading = document.getElementById('loading');

    if (!targetUrl) {
      loading.innerHTML = '<div style="text-align: center;"><h2>No URL provided</h2><p>Use: /proxy-frame.html?url=https://example.com</p></div>';
      return;
    }

    // Try to parse the URL
    let url;
    try {
      url = new URL(targetUrl);
    } catch (e) {
      // If it's just a domain, add https://
      if (/^[a-z0-9][\w.-]*\.[a-z]{2,}/i.test(targetUrl)) {
        url = new URL('https://' + targetUrl);
      } else {
        loading.innerHTML = '<div style="text-align: center;"><h2>Invalid URL</h2></div>';
        return;
      }
    }

    // Set the iframe src to load through the proxy API
    iframe.src = '/api/proxy?url=' + encodeURIComponent(url.href);

    // Hide loading when iframe loads
    iframe.onload = () => {
      loading.classList.add('hidden');
    };

    // Handle navigation within iframe
    // When the iframe navigates to a new page, we update the history
    let lastIframeUrl = '';
    setInterval(() => {
      try {
        // This won't work due to cross-origin, but we can update URL based on user actions
        // For now, we'll keep the original URL in the address bar
      } catch (e) {
        // Cross-origin restriction
      }
    }, 1000);

    // Update page title when iframe loads
    iframe.onload = () => {
      loading.classList.add('hidden');
      try {
        const title = iframe.contentDocument?.title || 'Proxy';
        document.title = title;
      } catch (e) {
        // Cross-origin
      }
    };
  </script>
</body>
</html>
